// ==========================================================================
// Project:  Ember Addons
// Copyright: Â©2011 Capitainetrain and contributors.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================


(function(a){Ember.Route=Ember.Object.extend({target:null,method:null,staticRoutes:null,dynamicRoutes:null,wildcardRoutes:null,add:function(a,b,c){var d,e;a=Ember.copy(a);if(!a||a.length===0)this.target=b,this.method=c;else{d=a.shift();switch(d.slice(0,1)){case":":d=d.slice(1,d.length),this.dynamicRoutes||(this.dynamicRoutes={}),this.dynamicRoutes[d]||(this.dynamicRoutes[d]=Ember.Route.create()),e=this.dynamicRoutes[d];break;case"*":d=d.slice(1,d.length),this.wildcardRoutes||(this.wildcardRoutes={}),e=this.wildcardRoutes[d]=Ember.Route.create();break;default:this.staticRoutes||(this.staticRoutes={}),this.staticRoutes[d]||(this.staticRoutes[d]=Ember.Route.create()),e=this.staticRoutes[d]}e&&e.add(a,b,c)}},routeForParts:function(a,b){var c,d,e;a=Ember.copy(a);if(!a||a.length===0)return this.method?this:null;c=a.shift();if(this.staticRoutes&&this.staticRoutes[c]){e=this.staticRoutes[c].routeForParts(a,b);if(e)return e}for(d in this.dynamicRoutes){e=this.dynamicRoutes[d].routeForParts(a,b);if(e)return b[d]=c,e}for(d in this.wildcardRoutes)return a.unshift(c),b[d]=a.join("/"),this.wildcardRoutes[d].routeForParts(null,b);return null}})})({}),function(a){function f(a){var d=window.location.hash;d=d&&d.length>0?d.slice(1,d.length):"",jQuery.browser.mozilla||(d=decodeURI(d)),b(this,"location")!==d&&!this._skipRoute&&Ember.run.once(this,function(){this._skipPush=!0,c(this,"location",d),this._skipPush=!1}),this._skipRoute=!1}function g(a){var d=b(this,"baseURI"),e=d.charAt(0)==="/"?document.location.pathname:document.location.href;e.slice(0,d.length)===d&&(e=e.slice(d.length+1,e.length),b(this,"location")!==e&&!this._skipRoute&&Ember.run.once(this,function(){this._skipPush=!0,c(this,"location",e),this._skipPush=!1})),this._skipRoute=!1}var b=Ember.get,c=Ember.set,d=!!window.history&&!!window.history.pushState,e="onhashchange"in window&&(document.documentMode===undefined||document.documentMode>7);Ember.RoutesManager=Ember.Object.extend({wantsHistory:!1,usesHistory:null,baseURI:document.baseURI,_didSetup:!1,_location:null,_firstRoute:null,_extractParametersAndRoute:function(a){var b={},c=a.route||"",d,e,f,g,h,i;d="?",e=c.split(d),c=e[0],e.length===1?e=[]:e.length===2?e=e[1].split("&"):e.length>2&&e.shift(),g=e.length;for(f=0;f<g;++f)h=e[f].split("="),b[h[0]]=h[1];for(i in a)a.hasOwnProperty(i)&&i!=="route"&&(b[i]=""+a[i]);e=[];for(i in b)e.push([i,b[i]].join("="));return b.params=d+e.join("&"),b.route=c,b},location:Ember.computed(function(a,b){return this._skipRoute=!1,this._extractLocation(a,b)}).property(),_extractLocation:function(a,c){var d,e;if(c!==undefined){c===null&&(c=""),typeof c=="object"&&(d=this._extractParametersAndRoute(c),c=d.route+d.params);if(!this._skipPush&&(!Ember.empty(c)||this._location&&this._location!==c)){e=encodeURI(c);if(this.usesHistory)e.length>0&&(e="/"+e),window.history.pushState(null,null,b(this,"baseURI")+e);else if(e.length>0||window.location.hash.length>0)window.location.hash=e}this._location=c}return this._location},updateLocation:function(a){return this._skipRoute=!0,this._extractLocation("location",a)},ping:function(){if(!this._didSetup){this._didSetup=!0;var a,c,h,i;b(this,"wantsHistory")&&d?(this.usesHistory=!0,a=window.location.hash.slice(1),a.length>0&&(a="/"+a,window.history.replaceState(null,null,b(this,"baseURI")+a)),g.call(this),Ember.$(window).bind("popstate",Ember.$.proxy(g,this))):(this.usesHistory=!1,b(this,"wantsHistory")&&(c=b(this,"baseURI"),h=c.charAt(0)==="/"?document.location.pathname:document.location.href.replace(document.location.hash,""),a=h.slice(c.length+1),a.length>0&&(window.location.href=c+"#"+a)),e?(f.call(this),Ember.$(window).bind("hashchange",Ember.$.proxy(f,this))):(i=Ember.$.proxy(function(){f.call(this),setTimeout(i,100)},this),i()))}},add:function(a,b,c){return this._didSetup||Ember.run.once(this,"ping"),c===undefined&&Ember.typeOf(b)==="function"?(c=b,b=null):Ember.typeOf(c)==="string"&&(c=b[c]),this._firstRoute||(this._firstRoute=Ember.Route.create()),this._firstRoute.add(a.split("/"),b,c),this},locationDidChange:Ember.observer(function(){this.trigger()},"location"),trigger:function(){var a=b(this,"location"),c,d;this._firstRoute&&(c=this._extractParametersAndRoute({route:a}),a=c.route,delete c.route,delete c.params,d=this.getRoute(a,c),d&&d.method&&d.method.call(d.target||this,c))},getRoute:function(a,b){var c=this._firstRoute;return Ember.none(b)&&(b={}),c.routeForParts(a.split("/"),b)},exists:function(a,b){return a=this.getRoute(a,b),a!==null&&a.method!==null}}),Ember.routes=Ember.RoutesManager.create()}({}),function(a){}({}),function(a){}({})

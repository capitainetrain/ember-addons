// ==========================================================================
// Project:  Ember Addons
// Copyright: Â©2011 Capitainetrain and contributors.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================


(function(a){var b=Ember.get,c=Ember.set,d=Ember.getPath,e=Ember.setPath,f=Array.prototype.slice,g=Ember.String.fmt,h=SC.computed(function(a){var c=b(this,"parentState");if(c)return b(c,a)}).property(),i=Em.State.extend({isLoaded:h,isDirty:h,isSaving:h,isDeleted:h,isError:h,isNew:h,isValid:h}),j=function(a,b){$.holdReady(!0),Ember.$.ajax(d(a,"module.url"),{dataType:"module",context:a,success:function(){b?this.goToState("ready"):this.goToState("loaded")},error:function(){this.goToState("error")},complete:function(){$.holdReady(!1)}})},k={rootState:Ember.State.create({isReady:!1,isLoaded:!1,isLoading:!1,isPrefetching:!1,load:function(a){a.goToState("loading")},prefetch:function(a){a.goToState("prefetching")},prefetching:i.create({isPrefetching:!0,isLoading:!0,enter:function(a){j(a)}}),loading:i.create({isLoading:!0,enter:function(a){j(a,!0)}}),loaded:i.create({isLoaded:!0,load:function(a){a.goToState("ready")},prefetch:Ember.K,ready:i.create({isReady:!0,enter:function(){var a=b(this,"module"),c=b(a,"source");typeof c=="string"&&(jQuery.globalEval(c),e(this,"module.source",null)),a.invokeCallbacks()}})})})},l=Ember.StateManager.extend({module:null,initialState:"rootState",states:k}),m=Em.computed(function(a){return b(d(this,"stateManager.currentState"),a)}).property("stateManager.currentState").cacheable();Em.Module=Ember.Object.extend({isReady:m,isLoaded:m,isLoading:m,isPrefetched:m,prefetchDelay:500,init:function(){var a=a.create({module:this});c(this,"stateManager",a),b(this,"isPrefetching")&&a.goToState("prefetch")},load:function(a,c){var d=b(this,"stateManager"),e;c===undefined&&Ember.typeOf(a)==="function"?(c=a,a=null,e=f.call(arguments,1)):e=f.call(arguments,2),this.addCallback(a,c,e),d.send("load",d)},prefetch:function(){var a=b(this,"stateManager");a.send("prefetch",a)},addCallback:function(a,b,c){this._callbacks=this._callbacks||[],this._callbacks.push({target:a,method:b,args:c})},invokeCallbacks:function(){var a,b,c,d=this._callbacks;for(a=0,b=d.length;a<b;a++)c=d[a],c.method.apply(c.target,c.args);this._callbacks=[]}}),Ember.ModulesManager=Ember.Object.extend({init:function(){this._super(),this._initializeModules()},_initializeModules:function(){var a=b(this,"modules"),c,d=[],e;if(a)for(e in a)c=a[e],Ember.typeOf(c)==="object"&&(c=Ember.Module.create({name:e,modulesManager:this},c),a[e]=c,c.isPrefetched&&c.prefetch())},loadModule:function(a,b,c){var e=d(this,"modules."+a);if(e)e.load.apply(e,f.call(arguments,1));else throw new Ember.Error(g("%@ module not found",[a]))},prefetchModule:function(a){var b=d(this,"modules."+a);if(b)b.prefetch();else throw new Ember.Error(g("%@ module not found",[a]))},isModuleReady:function(a){return!!d(this,"modules."+a+".isReady")}}),Ember.$(function(){Ember.MODULES&&(Ember.modules=Ember.ModulesManager.create({modules:Ember.MODULES}),delete Ember.MODULES)})})({}),function(a){var b=Ember.get,c=Ember.set,d=Ember.getPath,e=Array.prototype.slice,f=Ember.String.fmt;Ember.Module=Ember.Object.extend({isReady:!1,isLoaded:!1,isLoading:!1,isPrefetched:!1,prefetchDelay:500,load:function(a,c){var d=e.call(arguments,2),f=this,g;return c===undefined&&Ember.typeOf(a)==="function"&&(c=a,a=null),g=function(a){a===f&&(amplify.unsubscribe("ember:modules:ready",g),c&&c.apply(this,d))},amplify.subscribe("ember:modules:ready",a,g),b(this,"isPrefetching",!1),b(this,"isLoaded")?(this.execute(),!0):(this.fetch(),!1)},fetch:function(){if(b(this,"isLoading")||b(this,"isLoaded"))return;c(this,"isLoading",!0),$.holdReady(!0),Ember.$.ajax(b(this,"url"),{dataType:"script",context:this,success:function(){c(this,"isLoaded",!0),b(this,"isPrefetching")||this.execute()},complete:function(){c(this,"isLoading",!1),b(this,"isPrefetching",!1),$.holdReady(!1)}})},prefetch:function(){if(b(this,"isLoading")||b(this,"isLoaded"))return;b(this,"isPrefetching",!0),Ember.run.later(this,"fetch",b(this,"prefetchDelay"))},execute:function(){if(!b(this,"isReady")){var a=b(this,"source");typeof a=="string"&&(jQuery.globalEval(a),c(this,"source",null)),c(this,"isReady",!0)}amplify.publish("ember:modules:ready",this)}}),Ember.ModulesManager=Ember.Object.extend({init:function(){this._super(),this._initializeModules()},_initializeModules:function(){var a=b(this,"modules"),c,d=[],e;if(a)for(e in a)c=a[e],Ember.typeOf(c)==="object"&&(c=Ember.Module.create({name:e,modulesManager:this},c),a[e]=c,c.isPrefetched&&c.prefetch())},loadModule:function(a,b,c){var g=d(this,"modules."+a);if(g)g.load.apply(g,e.call(arguments,1));else throw new Ember.Error(f("%@ module not found",[a]))},prefetchModule:function(a){var b=d(this,"modules."+a);if(b)b.prefetch();else throw new Ember.Error(f("%@ module not found",[a]))},isModuleReady:function(a){var b=d(this,"modules."+a);return b?!!b.isReady:!1}}),Ember.$(function(){Ember.MODULES&&(Ember.modules=Ember.ModulesManager.create({modules:Ember.MODULES}),delete Ember.MODULES)})}({}),function(a){}({})
